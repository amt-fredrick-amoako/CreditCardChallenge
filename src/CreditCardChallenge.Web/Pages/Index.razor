@page "/"
@inject IJSRuntime JavaScript
@inject HttpClient HttpClient
@inject CardDetailsValidator CardDetailsValidator


<form method="post" class="form-container" @onsubmit="SubmitForm">

    <div class="cards @(isRotated ? "rotate" : "")">
        <CardComponent CardDetails="@CardDetails"
                       MonthExpiry="@MonthExpiry"
                       YearExpiry="@YearExpiry"
                       YearValueExpiry="@YearValueExpiry"
                       MonthValueExpiry="@MonthValueExpiry"
                       CardNumberFocus="@CardNumberAnimation"
                       CardNameFocus="@CardNameAnimation"
                       CardDateFocus="@CardDateAnimation"
                       IsInputActive="@IsInputActive"
                       Style="@Style" />
    </div>

    <div class="form-input">
        <div class="input-container w-100">
            <label for="cardNumber" class="form-label">Card Number</label>
            <input @attributes="@CardNumberAttributes"
            @onfocusin="@(args => {CardNumberAnimation = "field-focus card-number-focus"; Style = new Dictionary<string, object>
                {
                    {"style", "opacity: 1; top: 122px; left: 25px; width: 397px; height: 54px;"}
                };})"
            @onfocusout="@(args => CardNumberAnimation = "")"
            @oninput="args => HandleNumberInput(args)"
            @onkeyup="HandleKeyUp"
                   name="cardNumber" value="@CardDetails.CardNumber">
            <span class="validation-message">
                @(validationErrors?.Errors.FirstOrDefault(e => e.PropertyName == nameof(CardDetails.CardNumber))?.ErrorMessage)
            </span>
        </div>
        <div class="input-container w-100">
            <label for="cardName" class="form-label">Card Name</label>
            <input @attributes="@CardNameAttributes"
            @onfocusin="@(args => {CardNameAnimation = "field-focus card-name-focus"; Style=new Dictionary<string, object>
                {
                    {"style", "opacity: 1; top: 210px; left: 20px; width: 277px; height: 76px;"}
                };})"
            @onfocusout="@(args => CardNameAnimation = "")"
            @oninput="args => HandleNameInput(args)" name="cardName" value="@CardDetails.CardName">
            <span class="validation-message">
                @(validationErrors?.Errors.FirstOrDefault(e => e.PropertyName == nameof(CardDetails.CardName))?.ErrorMessage)
            </span>
        </div>
        <div class="security w-100 justify-content-between">
            <div class="select-container w-75"
            @onclick="@(args => {CardDateAnimation = "field-focus card-date-focus"; Style=new Dictionary<string, object>
                {
                {"style","opacity: 1; top: 183px; left: 368.475px; width: 104px; height: 92px;"}
                };})"
            @onfocusout="@(args => CardDateAnimation = "")">
                <label for="expiry" class="form-label">Expiration Date</label>
                <select @onchange="args => HandleMonthChange(args)" id="expiry" name="month" class="mr-20 form-select d-inline">
                    <option disabled selected value="">Month</option>
                    @foreach (var month in Months)
                    {
                        <option value="@month">@month</option>
                    }
                </select>

                <select @onchange="args => HandleYearChange(args)" name="year" class="form-select d-inline">
                    <option disabled selected value="">Year</option>
                    @foreach (var year in Years)
                    {
                        <option value="@year">@year</option>
                    }
                </select>

            </div>
            <div class="input-container">
                <label for="cvv" class="form-label">CVV</label>
                <input id="cvv" maxlength="4" type="number" class="cvv form-control" @bind="@CardDetails.Cvv" @bind:event="oninput" @onfocusin="Rotate" @onfocusout="RotateBack" name="cvv" />
                <span class="validation-message">
                    @(validationErrors?.Errors.FirstOrDefault(e => e.PropertyName == nameof(CardDetails.Cvv))?.ErrorMessage)
                </span>
            </div>
        </div>
        <div class="input-container">
            <button class="btn btn-primary button">Submit</button>
        </div>
    </div>
</form>

@code {
    CardDetails? CardDetails { get; set; }

    Dictionary<string, object> CardNumberAttributes { get; set; } = new()
    {
        {"id", "cardNumber"},
        {"maxlength", "16"},
        {"type", "number"},
        {"format", "^[0-9]{16}$"},
        {"class", "form-control mb-3"}
    };

    Dictionary<string, object> CardNameAttributes { get; set; } = new()
    {
        {"id", "cardName"},
        {"type", "text"},
        {"class", "form-control mb-3"}
    };

    string[] Years { get; set; }

    string[] Months { get; set; }

    bool isRotated = false;

    ValidationResult validationErrors;

    string MonthExpiry { get; set; } = string.Empty;
    string YearExpiry { get; set; } = string.Empty;
    string MonthValueExpiry { get; set; } = string.Empty;
    string YearValueExpiry { get; set; } = string.Empty;
    string CardNumberAnimation { get; set; } = string.Empty;
    string CardNameAnimation { get; set; } = string.Empty;
    string CardDateAnimation { get; set; } = string.Empty;
    bool IsInputActive { get; set; } = false;
    Dictionary<string, object> Style { get; set; } = new();
    void Rotate()
    {
        isRotated = true;
    }

    void RotateBack()
    {
        isRotated = false;
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();
        CardDetails = new();

        Months = Enumerable.Range(1, 12)
        .Select(month => month.ToString("D2"))
        .ToArray();

        Years = Enumerable.Range(2019, 12)
        .Select(year => year.ToString())
        .ToArray();

    }

    // display message modal
    async void ShowMessage(CardResponse response)
    {

        var messageParams = new
        {
            title = response.Message,
            text = $"Name on Card: {response.CardName}, Card Number: {response.CardNumber}, Card Expiry {response.Month}/{response.Year}, CVV: {response.Cvv}",
            icon = "success",
            buttons = new
            {
                confirm = new { text = "Okay", value = true }
            },
            dangerMode = false
        };

        await JavaScript.InvokeAsync<bool>("swal", messageParams);
    }

    // makes a post request when form is submitted
    async void SubmitForm()
    {
        // perform model validations using fluent validator
        validationErrors = CardDetailsValidator.Validate(CardDetails);

        if (validationErrors.IsValid)
        {
            var response = await HttpClient.PostAsJsonAsync($"https://localhost:7063/validate", CardDetails);
            var message = await response.Content.ReadAsStringAsync();
            var cardResponse = JsonConvert.DeserializeObject<CardResponse>(message);
            ShowMessage(cardResponse);
        }
        else
        {
            foreach (var error in validationErrors.Errors)
            {
                Console.WriteLine(error.ErrorMessage);
            }
        }
    }

    private void ChangeExpiryClass()
    {
        MonthExpiry = "text-expires";
    }

    void HandleNameInput(ChangeEventArgs args) => CardDetails.CardName = args.Value as string;

    void HandleNumberInput(ChangeEventArgs args) => CardDetails.CardNumber = args.Value as string;

    void HandleMonthChange(ChangeEventArgs args)
    {
        CardDetails.Month = args.Value as string;
        MonthExpiry = "swipe-up";
        MonthValueExpiry = "swipe-value-up";
    }

    void HandleYearChange(ChangeEventArgs args)
    {
        CardDetails.Year = args.Value as string;
        YearExpiry = "swipe-up";
        YearValueExpiry = "swipe-value-up";
    }

    void HandleNumberFocus(FocusEventArgs args)
    {
        CardNumberAnimation = "field-focus card-number-focus";
    }

    private void HandleKeyUp(KeyboardEventArgs args)
    {
        Console.WriteLine($"Key: {args.Key} pressed!");
    }

}
